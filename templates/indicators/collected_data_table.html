
<style>
    .disable-span {
        cursor: not-allowed;
        opacity: .65;
    }
    .disable-span a {
        pointer-events: none;
    }
</style>
<script type="text/javascript">
    $("#id_indicator_data_span_count_" + `{{indicator.id}}`).text("{{ indicator.collecteddata_set.count|default:0 }}" );
</script>
{% load assign %}
{% load i18n %}
{% if indicator.target_frequency  %}
    <table class="table table-sm table-bordered">
        <thead>
            <tr>
                <th style="vertical-align:bottom; min-width:190px;">{% trans "TARGET PERIOD" %}</th>
                <th style="vertical-align:bottom; text-align: right;">{% trans "TARGET" %}</th>
                <th style="vertical-align:bottom; text-align: right;">{% trans "ACTUAL" %}</th>
                <th style="vertical-align:bottom; text-align: right;">{% trans "% MET" %}</th>
                <th style="vertical-align:bottom; min-width: 125px;">{% trans "DATA COLLECTED" %}</th>
                <th style="vertical-align:bottom;">{% trans "EVIDENCE" %}</th>
                <th style="vertical-align:bottom;" width="80"></th>
            </tr>
        </thead>
        {% for item in periodictargets %}
            <tr>
                {% ifchanged item %}
                    {% with dataCount=item.collecteddata_set.count %}
                        <td {% if dataCount %} rowspan="{{ dataCount }}" {% endif %} min-width="190">
                            <strong>{{ item.period }}</strong><br>
                            <small>
                                {{ item.start_date_formatted|default_if_none:"" }}
                                {% if item.start_date %} - {% endif %}
                                {{ item.end_date_formatted|default_if_none:"" }}
                            </small>
                        </td>
                        <td {% if dataCount %} rowspan="{{ dataCount }}" {% endif %} align="right">
                            {% with target=item.target|floatformat:"-2" %}
                                {% if indicator.unit_of_measure_type == 2 %}
                                    {{ target }}%
                                {% else %}
                                    {{ target }}
                                {% endif %}
                            {% endwith %}
                        </td>
                        <td {% if dataCount %} rowspan="{{ dataCount }}" {% endif %} align="right">
                            {% if indicator.unit_of_measure_type == 1 %}
                                {% if indicator.is_cumulative == True %}
                                    {{ item.cumulative_sum|floatformat:"-2" }}
                                {% else %}
                                    {{ item.achieved_sum|floatformat:"-2" }}
                                {% endif %}
                            {% else %}
                                {% if indicator.is_cumulative == True %}
                                    {% if item.last_data_row %}
                                        {{ item.last_data_row|floatformat:"-2" }}%
                                    {% endif %}
                                {% else %}
                                    {% if item.achieved_avg %}
                                        <small><abbr title='{% trans "Average" %}'>{% trans "avg." %}</abbr></small>
                                        {{ item.achieved_avg|floatformat:"-2" }}%
                                    {% endif %}
                                {% endif %}
                            {% endif %}
                        </td>
                        <td {% if dataCount %} rowspan="{{ dataCount }}" {% endif %} align="right">
                            {% if indicator.unit_of_measure_type == 1 %}
                                {% if indicator.is_cumulative == True %}
                                    {% widthratio item.cumulative_sum item.target 100 as percent_met %}
                                    {% if percent_met %} {{ percent_met }}% {% endif %}
                                {% else %}
                                    {% widthratio item.achieved_sum item.target 100 as percent_met %}
                                    {% if percent_met %} {{ percent_met }}% {% endif %}
                                {% endif %}
                            {% else %}
                                {% if indicator.is_cumulative == True %}
                                    {% widthratio item.last_data_row item.target 100 as percent_met %}
                                    {% if percent_met %} {{ percent_met }}% {% endif %}
                                {% else %}
                                    {% widthratio item.achieved_avg item.target 100 as percent_met %}
                                    {% if percent_met %} {{ percent_met }}% {% endif %}
                                {% endif %}

                            {% endif %}

                        </td>
                    {% endwith %}
                {% endifchanged %}

                {% for cdata in item.collecteddata_set.all %}
                    {% if not forloop.first %}
                        <tr>
                    {% endif %}
                    <td {% if cdata.periodic_target == None %}
                            style="border: 3px solid red;"
                        {% endif %}>

                        <a href="{% url 'collecteddata_update' cdata.id %}"
                           class="collecteddata-link"
                           id="collected-{{cdata.id}}">
                                {{ cdata.date_collected_formatted|default_if_none:"" }}
                        </a>

                        <span class="float-right">
                            {% with achieved=cdata.achieved|floatformat:"-2" %}
                                {% if indicator.unit_of_measure_type == 2 %}
                                    {{ achieved }}%
                                {% else %}
                                    {{ achieved }}
                                {% endif %}
                            {% endwith %}
                        </span>
                    </td>
                    <td>
                        {% if cdata.evidence %}
                            {% if cdata.evidence.url %}
                                <a href="{{cdata.evidence.url}}" target="_blank">
                            {% endif %}
                            {{ cdata.evidence|default_if_none:"" }}
                            {% if cdata.evidence.url %}
                                </a>
                            {% endif %}
                        {%endif%}
                        <span class="float-right">
                            {% if cdata.complete %}
                                <a href="{% url 'projectcomplete_update' cdata.complete.id %}"
                                   target="_blank"
                                   class="btn btn-sm btn-link">{% trans "View Project" %}</a>
                            {% elif cdata.agreement %}
                                <a href="{% url 'projectagreement_update' cdata.agreement.id %}"
                                   target="_blank"
                                   class="btn btn-sm btn-link">{% trans "View Project" %}</a>
                            {% endif %}
                            {% comment {{ cdata.complete|default_if_none:cdata.agreement|default_if_none:'' }} %} {% endcomment %}
                        </span>
                        {% if cdata.tola_table %}
                            <a href="{{ cdata.tola_table.detail_url }}" target="_blank">{{ cdata.tola_table }}</a>
                        {% endif %}
                    </td>
                    <td align="right">
                        <a href="{% url 'collecteddata_delete' cdata.id %}" style="color:red; vertical-align: middle;">
                            <i class="fas fa-trash-alt"></i>
                        </a>
                        <a href="{% url 'collecteddata_update' cdata.id %}" class="collecteddata-link" style="padding-left: 30px; vertical-align: middle">
                            <i class="fas fa-edit"></i>
                        </a>
                    </td>
                    {% empty %}
                        <td style="white-space: nowrap; overflow: visible; max-width: 125px; border-right: 0px solid;">
                            {% trans "No data collected" %}
                        </td>
                        <td colspan="5" style="border-left: 0px solid;"></td>
                    {% if item.collecteddata_set.count > 1 %}
                        </tr>
                    {% endif %}
                {% endfor %}
            </tr>
        {% endfor %}

        {% for coldata in collecteddata_without_periodictargets %}
            <tr>
                <td></td>
                <td></td>
                <td align="right">
                    {% if indicator.unit_of_measure_type == 1 %}
                        {{ coldata.achieved|floatformat:"-2" }}
                    {% else %}
                        {{ coldata.achieved|floatformat:"-2" }}%
                    {% endif %}
                </td>
                <td align="right"></td>
                <td style="border: 3px solid red;">
                    <a href="{% url 'collecteddata_update' coldata.id %}" class="collecteddata-link" id="collected-{{coldata.id}}">
                        {{ coldata.date_collected_formatted|default_if_none:"" }}
                    </a>
                </td>
                <td>
                    {% if coldata.evidence %}
                        {% if coldata.evidence.url %}
                            <a href="{{coldata.evidence.url}}" target="_blank">
                        {% endif %}
                        {{ coldata.evidence|default_if_none:"" }}
                        {% if coldata.evidence.url %}
                            </a>
                        {% endif %}
                    {%endif%}
                    <span class="float-right">
                        {% if coldata.complete %}
                            <a href="{% url 'projectcomplete_update' coldata.complete.id %}"
                               target="_blank"
                               class="btn btn-sm btn-link">{% trans "View Project" %}</a>
                        {% elif coldata.agreement %}
                            <a href="{% url 'projectagreement_update' coldata.agreement.id %}"
                               target="_blank"
                               class="btn btn-sm btn-link">{% trans "View Project" %}</a>
                        {% endif %}
                        {% comment {{ coldata.complete|default_if_none:coldata.agreement|default_if_none:'' }} %} {% endcomment %}
                    </span>
                    {% if coldata.tola_table %}
                        <a href="{{ coldata.tola_table.detail_url }}" target="_blank">{{ coldata.tola_table }}</a>
                    {% endif %}
                </td>
                <td align="right">
                    <a href="{% url 'collecteddata_delete' coldata.id %}" style="color:red; vertical-align: middle;">
                        <i class="fas fa-trash-alt"></i>
                    </a>
                    <a href="{% url 'collecteddata_update' coldata.id %}" class="collecteddata-link" style="padding-left: 30px; vertical-align: middle">
                        <i class="fas fa-edit"></i>
                    </a>
                </td>
            </tr>
        {% endfor %}

        {% if collecteddata_without_periodictargets.count %}
            {% if indicator.target_frequency == None %}
                {% assign err 'Error_1' %}
            {% elif indicator.target_frequency == 2 or indicator.target_frequency == 8 %}
                {% assign err 'Error_2' %}
            {% else %}
                {% assign err 'Error_3' %}
            {% endif %}
        {% endif %}

        <tr style="background-color: #f5f5f5;">
            <td><strong>{% trans "Life of Program" %}</strong></td>
            <td align="right">
                <strong>
                    {% with lop=indicator.lop_target|floatformat:"-2" %}
                        {% if indicator.unit_of_measure_type == 2 %}
                            {{ lop }}%
                        {% else %}
                            {{ lop }}
                        {% endif %}
                    {% endwith %}
                </strong>
            </td>
            <td align="right">
                {% if indicator.unit_of_measure_type == 1 %}
                    {{ grand_achieved_sum|floatformat:"-2" }}
                {% else %}
                    {% if indicator.is_cumulative == True %}
                        {{ last_data_record_value|floatformat:"-2" }}%
                    {% else %}
                        {% widthratio grand_achieved_avg 3 1 as avg_of_grand_achieved_avg %}
                        <small><abbr title='{% trans "Average" %}'>{% trans "avg." %}</abbr></small>
                        {{ avg_of_grand_achieved_avg|floatformat:"-2" }}%
                    {% endif %}
                {% endif %}
            </td>
            <td align="right">
                <strong>
                    {% if indicator.unit_of_measure_type == 1 %}
                        {% widthratio grand_achieved_sum indicator.lop_target 100 %}%
                    {% else %}
                        {% if indicator.is_cumulative == True %}
                            {% widthratio last_data_record_value indicator.lop_target 100 %}%
                        {% else %}
                            {% widthratio grand_achieved_avg 3 1 as avg_of_grand_achieved_avg %}
                            {% widthratio avg_of_grand_achieved_avg indicator.lop_target 100 %}%
                        {% endif %}
                    {% endif %}
                </strong>
            </td>
            <td align="right">
            </td>
            <td colspan="3" align="right">
                <span class="{% if indicator.target_frequency == None or err == 'Error_1' %} disable-span {% endif %}">
                    <a href="{% url 'collecteddata_add' program_id indicator.id %}" class="btn-sm btn-info collecteddata-link"> New Data</a>
                </span>
            </td>
        </tr>

        {% if err %}
            <tr style="background-color: #f9f9f9;">
                <td colspan="8" style="color:red; border-color: #f9f9f9; border-left: 0px solid; border-right: 0px solid; border-bottom: 0px solid;">
                    <small>
                        {% ifequal err 'Error_1' %}
                            {% trans "Targets are not set up for this indicator." %} <strong><a href="{% url 'indicator_update' indicator.id %}" data-tab="#targets" class="indicator-link"> {% trans "Start by selecting a target frequency." %}</a></strong>
                        {% endifequal %}

                        {% ifequal err 'Error_2' %}
                                {% trans 'This record is not associated with a target. Open the data record and select an option from the "Measure against target" menu.' %}
                        {% endifequal %}

                        {% ifequal err 'Error_3' %}
                            {% trans "This date falls outside the range of your target periods. You can change the date or" %} <strong><a href="{% url 'indicator_update' indicator.id %}" data-tab="#targets" class="indicator-link">{% trans "create additional target periods." %}</a></strong>
                        {% endifequal %}
                    </small>
                </td>
            </tr>
        {% endif %}
    </table>
{% else %}
    <table border='0' vertical-align="top" align="center" height="130">
        <tr>
            <td valign="top" style="padding:2px;">
                <img src="/static/img/target.png" class="img-responsive center-block" height="85" width="85">
            </td>
            <td valign="top" style="padding-left:10px; padding-top: 38px; font-size: 1.375rem; color: #54585A;">
                {% trans "Organize your data for this indicator." %} <a href="{% url 'indicator_update' indicator.id %}" data-tab="#targets" class="indicator-link">{% trans "Set a target frequency." %}</a>
            </td>
        </tr>
    </table>
{% endif %}