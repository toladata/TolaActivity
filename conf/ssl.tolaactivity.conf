# wsgi is loaded here instead of httpd.conf so as to be outside of Puppet's control
LoadModule wsgi_module modules/mod_wsgi.so

<VirtualHost *:80>

    ServerName tola-activity.mercycorps.org
    ServerAlias tola-activity-dev.mercycorps.org
    ServerAlias tola-activity-test.mercycorps.org
    ServerAlias tola-activity-demo.mercycorps.org
    ServerAlias tola-activity-dev
    ServerAlias tola-activity-test
    ServerAlias tola-activity-demo

    RewriteEngine On

    RewriteCond %{REQUEST_METHOD} ^TRACE
    RewriteRule .* - [F]

    RewriteCond %{HTTP_HOST} ^tola-activity$ [NC]
    RewriteRule ^(.*)$ http://tola-activity.mercycorps.org$1 [R=301,L]

    RewriteCond %{HTTP_HOST} ^tola-activity-dev$ [NC]
    RewriteRule ^(.*)$ http://tola-activity-dev.mercycorps.org$1 [R=301,L]

    RewriteCond %{HTTP_HOST} ^tola-activity-test$ [NC]
    RewriteRule ^(.*)$ http://tola-activity-test.mercycorps.org$1 [R=301,L]

    RewriteCond %{HTTP_HOST} ^tola-activity-demo$ [NC]
    RewriteRule ^(.*)$ http://tola-activity-demo.mercycorps.org$1 [R=301,L]

    RewriteCond %{HTTPS} !on
    RewriteRule ^/(.*) https://%{SERVER_NAME}%{REQUEST_URI} [R]

</VirtualHost>

<VirtualHost *:443>
    ServerName tola-activity.mercycorps.org
    ServerAlias tola-activity-dev.mercycorps.org
    ServerAlias tola-activity-test.mercycorps.org
    ServerAlias tola-activity-demo.mercycorps.org

    SSLEngine on

    ErrorLog logs/tola_activity_error_log
    CustomLog logs/tola_activity_access_log combined
    LogLevel warn

    SSLProtocol all -SSLv2 -SSLv3
    SSLHonorCipherOrder on
    SSLCipherSuite "ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS"

    SSLCertificateFile /etc/httpd/conf/ssl.crt/star.mercycorps.org.crt
    SSLCertificateKeyFile /etc/httpd/conf/ssl.key/star.mercycorps.org.key
    SSLCACertificateFile /etc/httpd/conf/ssl.crt/DigiCertCA.crt

    CosignCheckIP never

    DocumentRoot /var/www/TolaActivity

    CosignProtected on
    CosignService tola

    CosignHostname login.mercycorps.org
    CosignRedirect https://login.mercycorps.org/
    CosignPostErrorRedirect https://login.mercycorps.org/post_error.html
    CosignCrypto /var/www/TolaActivity/conf/tola.key /var/www/TolaActivity/conf/tola.crt /etc/cosign/certs/ca

    Alias /static/ /var/www/TolaActivity/static/
    Alias /media/ /var/www/TolaActivity/media/

    <Directory /var/www/TolaActivity>
        Options +ExecCGI
        Order allow,deny
        Allow from all
    </Directory>

    <Location "/api">
        CosignProtected off
    </Location>

    <Location "/static">
        CosignProtected off
    </Location>

    WSGIPassAuthorization On
    WSGIDaemonProcess tola-activity processes=2 threads=25 display-name=%{GROUP}
    WSGIProcessGroup tola-activity

    WSGIScriptAlias / /var/www/TolaActivity/tola/wsgi.py

</VirtualHost>
